#include <Wire.h>                 
#include <LiquidCrystal_I2C.h>    
#include <SPI.h>                  
#include <MFRC522.h>              
#include <ESP32Servo.h>
#include <RCSwitch.h>

// Definição de variáveis

//Entrada Carros
const unsigned long CODIGO_BOTAO_A = 16736113; 
const unsigned long CODIGO_BOTAO_B = 543908; 

const int PINO_SERVO_ENTRADA = 13; 
const int PINO_SERVO_SAIDA = 32; 
const int PINO_RECEPTOR_RF = 27;

Servo servoEntrada;
Servo servoSaida;
RCSwitch mySwitch = RCSwitch();

//Entrada de moradores
#define I2C_SDA_PIN 25
#define I2C_SCL_PIN 26
LiquidCrystal_I2C lcd(0x27, 16, 2); 

#define SS_PIN    5  
#define RST_PIN   4 
MFRC522 mfrc522(SS_PIN, RST_PIN); 

#define SERVO_PIN 14 
#define ANGULO_PORTA_FECHADA 0
#define ANGULO_PORTA_ABERTA  90
#define TEMPO_PORTA_ABERTA 4000 
Servo portaServo;
bool portaEstaAberta = false;


const int NUMERO_MORADORES = 6;
struct Morador {
  String uid;
  String nome;
};

Morador moradores[NUMERO_MORADORES] = {
  {"EE FF 00 11", "Maria"},
  {"D3 16 EC 2C", "Mestra"},
  {"43 66 41 02", "Kelwin"},
  {"6A 5B A3 B6", "Kelwin FMU"},
  {"CF 79 49 B0", "Kelwin BU"}
};

//Pinos para a iluminação da Portaria
const int led = 15;
const int ldr = 34;

//Pinos para acionamento da cerca eletrica
const int interruptor = 16;
const int relay = 33;

//Pinos para detecção de vaga ocupada ou disponível
const int SensorVaga1 = 35;
const int SensorVaga2 = 36;
const int SensorVaga3 = 39;
const int LedVaga1 = 2;
const int LedVaga2 = 12;
const int LedVaga3 = 17;

const int NIVEL_OCUPADO = LOW; 

void inicializarLeds() {
  digitalWrite(LedVaga1, LOW);
  digitalWrite(LedVaga2, LOW);
  digitalWrite(LedVaga3, LOW);
}

void setup(){
	Serial.begin(115200);
	pinMode(led, OUTPUT);
	pinMode(ldr, INPUT);
	pinMode(interruptor, INPUT_PULLUP);
	pinMode(relay, OUTPUT);

	pinMode(SensorVaga1, INPUT);
	pinMode(SensorVaga2, INPUT);
	pinMode(SensorVaga3, INPUT);
	pinMode(LedVaga1, OUTPUT);
	pinMode(LedVaga2, OUTPUT);
	pinMode(LedVaga3, OUTPUT);
	inicializarLeds();

  	Wire.begin(I2C_SDA_PIN, I2C_SCL_PIN);
	lcd.init();
  	lcd.backlight();
  	mostrarMensagemPadrao();

  	portaServo.attach(SERVO_PIN);
  	portaServo.write(ANGULO_PORTA_FECHADA); 

  	SPI.begin();          
  	mfrc522.PCD_Init();  

	ESP32PWM::allocateTimer(0);
  	ESP32PWM::allocateTimer(1);

  	servoEntrada.attach(PINO_SERVO_ENTRADA);
  	servoSaida.attach(PINO_SERVO_SAIDA);

  	servoEntrada.write(ANGULO_PORTA_FECHADA);
  	servoSaida.write(ANGULO_PORTA_FECHADA);

  	mySwitch.enableReceive(digitalPinToInterrupt(PINO_RECEPTOR_RF));
}

void loop(){
	gerenciarLuzes();
  CercaEletrica();
	SensorDeVaga();
	AcessoMoradores();
	EntradaSaidaCarro();
}

void gerenciarLuzes(){
  int valorLDR = analogRead(ldr);
  Serial.print("Captacao de Luminosidade:" );
  Serial.println(valorLDR);
  delay(500);
  
  if(valorLDR > 900) {
  	digitalWrite(led, HIGH);
  } else {
  	digitalWrite(led, LOW);
  }
}

void CercaEletrica(){
  int valorINT = digitalRead(interruptor);
  Serial.print("Estado Interruptor:" );
  delay(500);
  
  if(valorINT == HIGH){
    digitalWrite(relay, HIGH);
    Serial.println("LOW");
  } else{
      digitalWrite(relay, LOW);
      Serial.println("HIGH");
    }
}

void SensorDeVaga() {
  int estadoVaga1 = digitalRead(SensorVaga1);

   if (estadoVaga1 == NIVEL_OCUPADO) {
    digitalWrite(LedVaga1, HIGH); 
    Serial.println("Vaga 1: OCUPADA");
  } else {
    digitalWrite(LedVaga1, LOW); 
    Serial.println("Vaga 1: Livre");
  }
  int estadoVaga2 = digitalRead(SensorVaga2);
  
  if (estadoVaga2 == NIVEL_OCUPADO) {
    digitalWrite(LedVaga2, HIGH); 
    Serial.println("Vaga 2: OCUPADA");
  } else {
    digitalWrite(LedVaga2, LOW); 
    Serial.println("Vaga 2: Livre");
  }
  int estadoVaga3 = digitalRead(SensorVaga3);
  
  if (estadoVaga3 == NIVEL_OCUPADO) {
    digitalWrite(LedVaga3, HIGH); 
    Serial.println("Vaga 3: OCUPADA");
  } else {
    digitalWrite(LedVaga3, LOW);  
    Serial.println("Vaga 3: Livre");
  }

  delay(250);
}

void AcessoMoradores() {
  if (portaEstaAberta) {
    return;
  }

  if ( ! mfrc522.PICC_IsNewCardPresent()) {
    return;
  }
  if ( ! mfrc522.PICC_ReadCardSerial()) {
    return;
  }

  String uidScaneado = "";
  for (byte i = 0; i < mfrc522.uid.size; i++) {
    uidScaneado.concat(String(mfrc522.uid.uidByte[i] < 0x10 ? " 0" : " "));
    uidScaneado.concat(String(mfrc522.uid.uidByte[i], HEX));
  }
  uidScaneado.toUpperCase();
  uidScaneado.trim();

  Serial.print("UID Scaneado: ");
  Serial.println(uidScaneado);

  String nomeAutorizado = "";
  bool acessoPermitido = false;

  for (int i = 0; i < NUMERO_MORADORES; i++) {
    if (uidScaneado == moradores[i].uid) {
      nomeAutorizado = moradores[i].nome;
      acessoPermitido = true;
      break;
    }
  }

  if (acessoPermitido) {
    Serial.print("Acesso Permitido para: ");
    Serial.println(nomeAutorizado);
    abrirPorta(nomeAutorizado); 
  } else {
    Serial.println("Acesso Negado!");
    mostrarAcessoNegado();
  }
  
  mfrc522.PICC_HaltA();
  mfrc522.PCD_StopCrypto1();
}

void abrirPorta(String nome) {
  portaEstaAberta = true; 

  lcd.clear();
  lcd.setCursor(3, 0);
  lcd.print("Bem vindo!");
  
  int padding = (16 - nome.length()) / 2;
  if (padding < 0) padding = 0;
  lcd.setCursor(padding, 1);
  lcd.print(nome);

  portaServo.write(ANGULO_PORTA_ABERTA);
  delay(TEMPO_PORTA_ABERTA);
  portaServo.write(ANGULO_PORTA_FECHADA);
  mostrarMensagemPadrao();
  portaEstaAberta = false; 
}

void mostrarAcessoNegado() {
  lcd.clear();
  lcd.setCursor(2, 0);
  lcd.print("Acesso Negado!");
  delay(2000);
  mostrarMensagemPadrao();
}

void mostrarMensagemPadrao() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Aprox. o cartao");
  lcd.setCursor(2, 1);
  lcd.print("ou a tag...");
}

void EntradaSaidaCarro() {
  if (mySwitch.available()) {
    
    unsigned long codigoRecebido = mySwitch.getReceivedValue();
    Serial.print("Código recebido: ");
    Serial.println(codigoRecebido);

    if (codigoRecebido == CODIGO_BOTAO_A) {
      Serial.println("Acionando Cancela de ENTRADA...");
      servoEntrada.write(ANGULO_PORTA_ABERTA); 
      delay(TEMPO_PORTA_ABERTA);     
      servoEntrada.write(ANGULO_PORTA_FECHADA);  
    }
    else if (codigoRecebido == CODIGO_BOTAO_B) {
      Serial.println("Acionando Cancela de SAÍDA...");
      servoSaida.write(ANGULO_PORTA_ABERTA);   
      delay(TEMPO_PORTA_ABERTA);   
      servoSaida.write(ANGULO_PORTA_FECHADA); 
    }

    mySwitch.resetAvailable();
  }
}
